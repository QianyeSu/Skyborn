name: "Test Documentation Deployment"

on:
  workflow_dispatch:  # Manual trigger only for testing

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-test"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-docs.txt
          pip install -e .

      - name: Verify Skyborn installation
        run: |
          python -c "import skyborn; print(f'Skyborn version: {skyborn.__version__}')"
          python -c "from skyborn.calculations import convert_longitude_range; print('âœ… Core modules imported successfully')"

      - name: Build English documentation
        run: |
          cd docs
          echo "ğŸ“š Building English documentation..."
          sphinx-build -b html source/en build/en/html -v
          echo "âœ… English documentation build completed"
          ls -la build/en/html/

      - name: Build Chinese documentation
        run: |
          cd docs
          echo "ğŸ“š Building Chinese documentation..."
          sphinx-build -b html source/zh_CN build/zh_CN/html -v
          echo "âœ… Chinese documentation build completed"
          ls -la build/zh_CN/html/

      - name: Prepare GitHub Pages
        run: |
          mkdir -p _site

          # Copy English docs as default
          if [ -d "docs/build/en/html" ]; then
            cp -r docs/build/en/html/* _site/
            mkdir -p _site/en
            cp -r docs/build/en/html/* _site/en/
            echo "âœ… English documentation copied"
          else
            echo "âŒ English documentation missing"
            exit 1
          fi

          # Copy Chinese docs
          if [ -d "docs/build/zh_CN/html" ]; then
            mkdir -p _site/zh_CN
            cp -r docs/build/zh_CN/html/* _site/zh_CN/
            echo "âœ… Chinese documentation copied"
          else
            echo "âš ï¸ Chinese documentation missing, creating placeholder"
            mkdir -p _site/zh_CN
            echo "<h1>æ–‡æ¡£æ„å»ºä¸­</h1><p>ä¸­æ–‡æ–‡æ¡£æ­£åœ¨æ„å»ºä¸­...</p>" > _site/zh_CN/index.html
          fi

          # Create main index with language selector
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Skyborn Documentation</title>
              <meta http-equiv="refresh" content="0;url=./en/">
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      text-align: center;
                      margin-top: 50px;
                      background-color: #f8f9fa;
                  }
                  .container {
                      max-width: 600px;
                      margin: 0 auto;
                      padding: 20px;
                  }
                  h1 { color: #2c3e50; }
                  .language-selector { margin: 30px 0; }
                  .language-selector a {
                      display: inline-block;
                      margin: 10px;
                      padding: 15px 30px;
                      background-color: #3498db;
                      color: white;
                      text-decoration: none;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      transition: background-color 0.3s;
                  }
                  .language-selector a:hover {
                      background-color: #2980b9;
                  }
                  .auto-redirect {
                      margin-top: 20px;
                      color: #7f8c8d;
                      font-size: 14px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸŒ¤ï¸ Skyborn Documentation</h1>
                  <p>Atmospheric data processing and analysis toolkit</p>
                  <div class="language-selector">
                      <a href="./en/">ğŸ“– English Documentation</a>
                      <a href="./zh_CN/">ğŸ“– ä¸­æ–‡æ–‡æ¡£</a>
                  </div>
                  <div class="auto-redirect">
                      <p>Automatically redirecting to English documentation...</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

          echo "ğŸ“ Final site structure:"
          find _site -type f -name "*.html" | head -10
          echo "ğŸ“Š Site size:"
          du -sh _site

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "ğŸ‰ Documentation deployment completed!"
          echo "ğŸ“– View at: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸŒ English: ${{ steps.deployment.outputs.page_url }}en/"
          echo "ğŸŒ Chinese: ${{ steps.deployment.outputs.page_url }}zh_CN/"
